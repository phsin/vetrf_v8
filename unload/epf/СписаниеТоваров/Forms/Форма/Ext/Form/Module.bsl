
#Область ОбработчикиСобытий

&НаСервере
Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)
	
	ДатаНачала = НачалоМесяца(ТекущаяДатаСеанса());
	ДатаОкончания = ТекущаяДатаСеанса();
	ЗаполнитьСтрокиТЧДокументамиРеализаций(ДатаНачала, ДатаОкончания);
	
КонецПроцедуры

#КонецОбласти

#Область ОбработчикиКомандФормы

&НаКлиенте
Процедура ОбновитьЗаПериод(Команда)
	
	Если Не ЗначениеЗаполнено(Период) Тогда
		кб99_ВСД.СообщитьПользователю(НСтр("ru = 'Не заполнено поле'"),, "Период", Период);
		Возврат;
	КонецЕсли;
	
	ОбновитьЗаПериодНаСервере();
	
КонецПроцедуры

&НаКлиенте
Процедура Списать(Команда)
	ЗаполнитьТаблицуПартийНаСервере();
КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

&НаСервере
Процедура ОбновитьЗаПериодНаСервере()
	ЗаполнитьСтрокиТЧДокументамиРеализаций(Период.ДатаНачала, Период.ДатаОкончания);
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьСтрокиТЧДокументамиРеализаций(ДатаНачала, ДатаОкончания);
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	РеализацияТоваровУслуг.Ссылка КАК ДокументРеализации
		|ИЗ
		|	Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.Партнеры КАК Партнеры
		|		ПО РеализацияТоваровУслуг.Партнер = Партнеры.Ссылка
		|ГДЕ
		|	РеализацияТоваровУслуг.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
		|	И Партнеры.ВСД_не_Выписываем";
	Запрос.УстановитьПараметр("ДатаНачала", ДатаНачала);
	Запрос.УстановитьПараметр("ДатаОкончания", ДатаОкончания);
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Если РезультатЗапроса.Пустой() Тогда
		Возврат;
	КонецЕсли;
	
	Список.Загрузить(РезультатЗапроса.Выгрузить());
	
КонецПроцедуры

&НаСервере
Процедура ЗаполнитьТаблицуПартийНаСервере()
	
	Организация = кб99_ВСД_Переопределения.ПолучитьОрганизациюПоУмолчанию();
	
	ПараметрыОрганизации = кб99_ВСД.ЗагрузитьПараметры(Организация);
	//Объект.ПоказыватьПросроченныеПартии = ПараметрыОрганизации.ПоказыватьПросроченныеПартии;
	
	//Объект.Партии.Очистить();
	
	// Подготовка требуемых партий из отгрузок
	ТаблицаОтгрузок = Список.Выгрузить();
	РезультатПодготовки = ПодготовитьТребуемыеПартии(
		ТаблицаОтгрузок, 
		ПараметрыОрганизации
	);
	
	ТребуемыеПартии = РезультатПодготовки.ТаблицаПартий;
	ПолеСортировкиПокупателя = РезультатПодготовки.ПолеСортировкиПокупателя;
	ЗнакСортировкиПокупателя = РезультатПодготовки.ЗнакСортировкиПокупателя;
	
	Если ТребуемыеПартии.Количество() = 0 Тогда
		кб99_ВСД.СообщитьИнфо("Нет документов к созданию списания ->");
		Возврат;
	КонецЕсли;
	
	// Переопределение знака сортировки если указан явно
	//Если ЗначениеЗаполнено(ЗнакСортировки) Тогда
	//	ЗнакСортировкиПокупателя = ЗнакСортировки;
	//КонецЕсли;
	
	Отправитель_ХозСубъект = ПолучитьХозСубъекта();
	Отправитель_Площадка = ПолучитьПлощадку(Отправитель_ХозСубъект);
	
	// Получение актуальных партий
	АктуальныеПартии = кб99_ВСД.ПолучитьАктуальныеПартии(
		ПараметрыОрганизации,
		ТребуемыеПартии.ВыгрузитьКолонку("ВСД_Продукция_Элемент"),
		//Объект.Отправитель_Площадка, 
		//Объект.Отправитель_ХозСубъект,
		Отправитель_Площадка,
		Отправитель_ХозСубъект,
		ПолеСортировкиПокупателя,
		ЗнакСортировкиПокупателя,
		ТребуемыеПартии.ВыгрузитьКолонку("Номенклатура")
	);
	
	Если НЕ (ТипЗнч(АктуальныеПартии) = Тип("ТаблицаЗначений")) И НЕ Объект.ПарамЗаполнятьТранзакциюПриОтсутствииПартий Тогда
		кб99_ВСД.СообщитьИнфо("Нет актуальных партий для создания Документов ");
		Возврат;
	КонецЕсли;
	
	// Уменьшаем актуальные партии на уже распределенные
	//УменьшитьАктуальныеПартииНаРаспределенные(АктуальныеПартии);
	
	// Распределение партий
	РаспределенныеПартии = кб99_ВСД_УправлениеФормой.РаспределитьПартииПоОстаткам(
		ТребуемыеПартии,
		АктуальныеПартии,
		ПараметрыОрганизации
	);
	
	СоздатьДокументИнвентаризации(РаспределенныеПартии, Организация, Отправитель_ХозСубъект, Отправитель_Площадка);
	
	// Загрузка результата в форму
	//Объект.Партии.Загрузить(РаспределенныеПартии);
	//РаскраситьТЧПартий();
	
КонецПроцедуры

&НаСервере
Функция ПодготовитьТребуемыеПартии(ТаблицаОтгрузок, ПараметрыОрганизации) //, РеквизитГрузополучатель)
	
	ВремПартии = Новый ТаблицаЗначений;
	ВремПартии.Колонки.Добавить("Номенклатура");
	ВремПартии.Колонки.Добавить("ВСД_Продукция_Элемент");
	ВремПартии.Колонки.Добавить("КоличествоСписания");
	ВремПартии.Колонки.Добавить("СерияНоменклатуры");
	ВремПартии.Колонки.Добавить("Документ");
	ВремПартии.Колонки.Добавить("ТермУсловияПеревозки");
	ВремПартии.Колонки.Добавить("Контрагент");
	ВремПартии.Колонки.Добавить("ВидПродукции");
	ВремПартии.Колонки.Добавить("ИдентификаторСтроки");
	
	ПолеСортировкиПокупателя = Неопределено;
	ЗнакСортировкиПокупателя = Неопределено;
	
	Для Каждого СтрОтгрузки Из ТаблицаОтгрузок Цикл
		
		Если НЕ СтрОтгрузки.Отметка Тогда
			Продолжить;
		КонецЕсли;
		
		// Проверка заполнения грузополучателя
		//Если НЕ ЗначениеЗаполнено(СтрОтгрузки.Грузополучатель) Тогда
		//	ПолеГрузополучатель = ПолучитьИмяРеквизитаГрузополучателя(РеквизитГрузополучатель);
		//	кб99_ВСД.СообщитьИнфо("В документе " + СтрОтгрузки.Док + " не заполнен реквизит " + ПолеГрузополучатель + " -> Пропускаю");
		//	Продолжить;
		//КонецЕсли;
		
		// Контроль уже отправленного/удаленного ВСД
		//Если ЗначениеЗаполнено(СтрОтгрузки.ВСД) Тогда
		//	кб99_ВСД.СообщитьИнфо("Для " + СтрОтгрузки.Док + " уже создан " + СтрОтгрузки.ВСД + " ->Пропускаю");
		//	Продолжить;
		//КонецЕсли;
		
		// Выгружаем товары из документа
		ТаблицаТоваров = кб99_ВСД_ЗаполнениеДокументов.ВыгрузитьТЧ(СтрОтгрузки.ДокументРеализации, ПараметрыОрганизации);
		Для Каждого СтрокаТоваров Из ТаблицаТоваров Цикл
			СтрокаПартий = ВремПартии.Добавить();
			СтрокаПартий.Номенклатура = СтрокаТоваров.Номенклатура;
			СтрокаПартий.ВСД_Продукция_Элемент = СтрокаТоваров.Продукция_Элемент;
			СтрокаПартий.КоличествоСписания = СтрокаТоваров.Количество;
			СтрокаПартий.СерияНоменклатуры = СтрокаТоваров.СерияНоменклатуры;
			СтрокаПартий.Документ = СтрОтгрузки.ДокументРеализации;
			//СтрокаПартий.Контрагент = СтрОтгрузки.Контрагент;
			СтрокаПартий.ТермУсловияПеревозки = СтрокаТоваров.ТермУсловияПеревозки;
			СтрокаПартий.ВидПродукции = СтрокаТоваров.ВидПродукции;
			СтрокаПартий.ИдентификаторСтроки = СтрокаТоваров.ИдентификаторСтроки;
		КонецЦикла;
		
		// Определение персональных параметров сортировки партий
		//Если СтрОтгрузки.Площадка.ПерсональныеПараметрыСписанияПартий Тогда 
		//	ПолеСортировкиПокупателя = СтрОтгрузки.Площадка.ПарамКолонкаСортировкиПартииСписания;
		//	ЗнакСортировкиПокупателя = СтрОтгрузки.Площадка.ПарамЗнакСортировкиУбывание;
		//	
		//	Если ПараметрыОрганизации["ВыводитьПодробнуюИнформацию"] Тогда 
		//		кб99_ВСД.СообщитьИнфо("! Сортировка партий в Площадке [" + СтрОтгрузки.Площадка + "] = " + 
		//			ПолеСортировкиПокупателя + " сортировка по LIFO = " + ЗнакСортировкиПокупателя);
		//	КонецЕсли;
		//	
		//ИначеЕсли СтрОтгрузки.ХозСубъект.ПерсональныеПараметрыСписанияПартий Тогда 
		//	ПолеСортировкиПокупателя = СтрОтгрузки.ХозСубъект.ПарамКолонкаСортировкиПартииСписания;
		//	ЗнакСортировкиПокупателя = СтрОтгрузки.ХозСубъект.ПарамЗнакСортировкиУбывание;
		//	
		//	Если ПараметрыОрганизации["ВыводитьПодробнуюИнформацию"] Тогда 
		//		кб99_ВСД.СообщитьИнфо("! Сортировка партий в ХозСубъекте [" + СтрОтгрузки.ХозСубъект + "] = " + 
		//			ПолеСортировкиПокупателя + " сортировка по LIFO = " + ЗнакСортировкиПокупателя);
		//	КонецЕсли;
		//КонецЕсли;
		
	КонецЦикла;
	
	ВремПартии.Свернуть("ВСД_Продукция_Элемент, СерияНоменклатуры, Номенклатура, Документ, ТермУсловияПеревозки, Контрагент, ВидПродукции, ИдентификаторСтроки", "КоличествоСписания");
	ВремПартии.Сортировать("ВСД_Продукция_Элемент");
	
	Результат = Новый Структура;
	Результат.Вставить("ТаблицаПартий", ВремПартии);
	Результат.Вставить("ПолеСортировкиПокупателя", ПолеСортировкиПокупателя);
	Результат.Вставить("ЗнакСортировкиПокупателя", ЗнакСортировкиПокупателя);
	
	Возврат Результат;
	
КонецФункции

&НаСервере
Функция ПолучитьХозСубъекта()
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВСД_ХозСубъект.Ссылка
		|ИЗ
		|	Справочник.ВСД_ХозСубъект КАК ВСД_ХозСубъект
		|ГДЕ
		|	ВСД_ХозСубъект.GUID = ""b26e9fef-560b-452f-8b53-d3d6b0322349""";
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
КонецФункции

&НаСервере
Функция ПолучитьПлощадку(ХозСубъект)
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ВСД_Площадка.Ссылка
		|ИЗ
		|	Справочник.ВСД_Площадка КАК ВСД_Площадка
		|ГДЕ
		|	ВСД_Площадка.ХозСубъект = &ХозСубъект";
	Запрос.УстановитьПараметр("ХозСубъект", ХозСубъект);
	
	Выборка = Запрос.Выполнить().Выбрать();
	Если Выборка.Следующий() Тогда
		Возврат Выборка.Ссылка;
	КонецЕсли;
	
КонецФункции

&НаСервере
Процедура СоздатьДокументИнвентаризации(РаспределенныеПартии, Организация, Отправитель_ХозСубъект, Отправитель_Площадка)
	
	Док = Документы.ВСД2_Инвентаризация.СоздатьДокумент();
	//Док.Заполнить(РаспределенныеПартии);
	
	ПараметрыОрганизации = кб99_ВСД.ЗагрузитьПараметры(Организация);
	
	Док.Организация = Организация;
	
	Док.Владелец_ХозСубъект = Отправитель_ХозСубъект;
	Док.Владелец_Площадка   = Отправитель_Площадка;
	
	Для Каждого СтрПартии Из РаспределенныеПартии Цикл
		
		Разница = СтрПартии.Остаток - СтрПартии.Количество;
		
		НоваяСтрока = Док.Продукция.Добавить();
		
		НоваяСтрока.КлючСтроки = Новый УникальныйИдентификатор();
		
		НоваяСтрока.Продукция_Элемент = СтрПартии.Продукция_Элемент;
		НоваяСтрока.Партия            = СтрПартии.Партия;
		
		НоваяСтрока.Количество       = Разница;
		НоваяСтрока.ЕдиницаИзмерения = НоваяСтрока.Партия.ЕдиницаИзмерения;
		
		//Если Не ЗначениеЗаполнено(НоваяСтрока.ЕдиницаИзмерения) Тогда
		//	кб99_ВСД.СообщитьИнфо("Не заполнена ЕдиницаИзмерения в " + НоваяСтрока.Продукция_Элемент);
		//КонецЕсли;
		
		ДатаИзготовления1 = СтрокаВДату(СтрПартии.Партия.ДатаИзготовления1);
		ДатаИзготовления1 = СтрокаВДату(СтрПартии.Партия.ДатаСрокГодности1);
		
		НоваяСтрока.ДатаИзготовления1 = ДатаИзготовления1;
		НоваяСтрока.ДатаСрокГодности1 = ДатаИзготовления1;
		
		НоваяСтрока.НаименованиеПродукции = НоваяСтрока.Продукция_Элемент.Наименование;
		
		НоваяСтрока.Производитель_площадка = НоваяСтрока.Продукция_Элемент.Площадка;
		НоваяСтрока.Производитель_Страна   = ?(ЗначениеЗаполнено(НоваяСтрока.Производитель_площадка.Страна),
			НоваяСтрока.Производитель_площадка.Страна,
			ПараметрыОрганизации["Страна"]);
			
		НоваяСтрока.Продукция    = НоваяСтрока.Продукция_Элемент.Продукция;
		НоваяСтрока.ВидПродукции = НоваяСтрока.Продукция_Элемент.ВидПродукции;
		
	КонецЦикла;
	
	Док.Дата = ТекущаяДатаСеанса();
	Док.Записать();
	
КонецПроцедуры

&НаСервере
Функция СтрокаВДату(СтрокаДаты)
	
	Попытка
		// Разбиваем строку на компоненты по разделителю "-"
		МассивКомпонентов = СтрРазделить(СтрокаДаты, "-", Ложь);
		
		// Проверяем количество компонентов
		Если МассивКомпонентов.Количество() <> 3 Тогда
			ВызватьИсключение "Некорректный формат даты. Требуется формат ГГГГ-ММ-ДД";
		КонецЕсли;
		
		// Преобразуем компоненты в числа
		Год   = Число(МассивКомпонентов[0]);
		Месяц = Число(МассивКомпонентов[1]);
		День  = Число(МассивКомпонентов[2]);
		
		// Создаем дату (время устанавливается в 00:00:00)
		Возврат Дата(Год, Месяц, День);
		
	Исключение
		// Формируем детальное сообщение об ошибке
		ОписаниеОшибки = СтрШаблон("Ошибка преобразования строки '%1' в дату.", СтрокаДаты) + Символы.ПС + ОписаниеОшибки();
		кб99_ВСД.СообщитьИнфо(ОписаниеОшибки);
	КонецПопытки;
	
КонецФункции

#КонецОбласти






