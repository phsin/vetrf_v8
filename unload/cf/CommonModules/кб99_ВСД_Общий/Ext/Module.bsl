// Использование модулей конфигурации
//Пример
//Функция СведенияОбАдресе(Адрес, ДополнительныеПараметры = Неопределено) Экспорт
//	Если Метаданные.ОбщиеМодули.Найти("РаботаСАдресами") <> Неопределено Тогда
//		МодульРаботаСАдресами = ОбщегоНазначения.ОбщийМодуль("РаботаСАдресами");
//		Возврат МодульРаботаСАдресами.СведенияОбАдресе(Адрес, ДополнительныеПараметры);
//	КонецЕсли;
// БП 3.0
// 		СведенияОПлательщике      = БухгалтерскийУчетПереопределяемый.СведенияОЮрФизЛице(СведенияОДокументе.Плательщик,      СведенияОДокументе.ДатаДляПолученияСведений);
//		СписокПлательщик = "НаименованиеДляПечатныхФорм,ИНН,Свидетельство,ЮридическийАдрес,Телефоны,НомерСчета,Банк,БИК,КоррСчет";
//		ПараметрыЗаполнения = Новый Структура;
//		ПараметрыЗаполнения.Вставить("ПредставлениеПлательщика", ОбщегоНазначенияБПВызовСервера.ОписаниеОрганизации(СведенияОПлательщике, СписокПлательщик));


// Возвращает серверный модуль менеджера по имени объекта.
//из типовой БП3   - получение нужного модуля конфы
Функция СтрРазделить82(Имя,знакДелителя)
	Рез = Новый СписокЗначений;
	Рез.Вставить("имя",имя);
	Возврат Рез;	
КонецФункции

Функция СерверныйМодульМенеджера(Имя)
	ОбъектНайден = Ложь;
	
	ЧастиИмени = СтрРазделить82(Имя, ".");
	Если ЧастиИмени.Количество() = 2 Тогда
		
		ИмяВида = ВРег(ЧастиИмени[0]);
		ИмяОбъекта = ЧастиИмени[1];
		
		Если ИмяВида = ВРег("Константы") Тогда
			Если Метаданные.Константы.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("РегистрыСведений") Тогда
			Если Метаданные.РегистрыСведений.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("РегистрыНакопления") Тогда
			Если Метаданные.РегистрыНакопления.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("РегистрыБухгалтерии") Тогда
			Если Метаданные.РегистрыБухгалтерии.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("РегистрыРасчета") Тогда
			Если Метаданные.РегистрыРасчета.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("Справочники") Тогда
			Если Метаданные.Справочники.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("Документы") Тогда
			Если Метаданные.Документы.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("Отчеты") Тогда
			Если Метаданные.Отчеты.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("Обработки") Тогда
			Если Метаданные.Обработки.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("БизнесПроцессы") Тогда
			Если Метаданные.БизнесПроцессы.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("ЖурналыДокументов") Тогда
			Если Метаданные.ЖурналыДокументов.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("Задачи") Тогда
			Если Метаданные.Задачи.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("ПланыСчетов") Тогда
			Если Метаданные.ПланыСчетов.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("ПланыОбмена") Тогда
			Если Метаданные.ПланыОбмена.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("ПланыВидовХарактеристик") Тогда
			Если Метаданные.ПланыВидовХарактеристик.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		ИначеЕсли ИмяВида = ВРег("ПланыВидовРасчета") Тогда
			Если Метаданные.ПланыВидовРасчета.Найти(ИмяОбъекта) <> Неопределено Тогда
				ОбъектНайден = Истина;
			КонецЕсли;
		КонецЕсли;
		
	КонецЕсли;
	
	Если Не ОбъектНайден Тогда
		ВызватьИсключение("ОШИБКА ПОЛУЧЕНИЯ МОДУЛЯ");
//		ВызватьИсключение СтроковыеФункцииКлиентСервер.ПодставитьПараметрыВСтроку(
//			НСтр("ru = 'Объект метаданных ""%1"" не найден,
//			|либо для него не поддерживается получение модуля менеджера.'"), Имя);
	КонецЕсли;
	
	Модуль = Вычислить(Имя); // ВычислитьВБезопасномРежиме не требуется, т.к. проверка надежная.
	
	Возврат Модуль;
КонецФункции

Функция ОбщийМодуль(Имя) Экспорт
	Попытка	
		Если Метаданные.ОбщиеМодули.Найти(Имя) <> Неопределено Тогда
			Модуль = Вычислить(Имя); // ВычислитьВБезопасномРежиме не требуется, т.к. проверка надежная.
		ИначеЕсли СтрЧислоВхождений(Имя, ".") = 1 Тогда
			Возврат СерверныйМодульМенеджера(Имя);
		Иначе
			Модуль = Неопределено;
		КонецЕсли;
	
		Если ТипЗнч(Модуль) <> Тип("ОбщийМодуль") Тогда			
			//ВызватьИсключение("ОШИБКА ПОЛУЧЕНИЯ МОДУЛЯ");//ПодставитьПараметрыВСтроку(НСтр("ru = 'Общий модуль ""%1"" не найден.'"), Имя);
		КонецЕсли;
	Исключение
		кб99_ВСД.СообщитьИнфо("Ошибка получения модуля Типовой конфигурации "+Имя+" "+ОписаниеОшибки());
		Возврат Неопределено;
	КонецПопытки;
	
	Возврат Модуль;
	
КонецФункции

Функция ПолучитьОрганизациюПоУмолчанию() Экспорт
	НазваниеКонфигурации = Метаданные.Имя;
	Версия = Лев(Метаданные.Версия,2);
	
	_Организация = Справочники.Организации.ПустаяСсылка();

	//БП 3	Организация = БухгалтерскийУчетПереопределяемый.ПолучитьЗначениеПоУмолчанию("ОсновнаяОрганизация");
	//УПП         Организация   =  УправлениеПользователями.ПолучитьЗначениеПоУмолчанию(глЗначениеПеременной("глТекущийПользователь"),"ОсновнаяОрганизация");
	
	Если Метаданные.Имя = "УправлениеТорговлей" Тогда 
		Если Версия="11" Тогда 
			
			МодульТиповойКонфы = ОбщийМодуль("ЗначениеНастроекПовтИсп");
			_Организация = МодульТиповойКонфы.ПолучитьОрганизациюПоУмолчанию( _Организация );
			
			Если НЕ ЗначениеЗаполнено( _Организация ) Тогда 
				Попытка
					// В УТ 11 Засада, добавим регистр сведений для определения основной организации
					Запрос = Новый Запрос;
					Запрос.Текст = "ВЫБРАТЬ
					               |	кб99_ОрганизацияПоУмолчанию.Организация
					               |ИЗ
					               |	РегистрСведений.кб99_ОрганизацияПоУмолчанию КАК кб99_ОрганизацияПоУмолчанию
					               |ГДЕ
					               |	кб99_ОрганизацияПоУмолчанию.Пользователь = &ВыбПользователь";
					Запрос.УстановитьПараметр("ВыбПользователь", ПараметрыСеанса.АвторизованныйПользователь);	
					Выборка = Запрос.Выполнить().Выбрать();
					Если Выборка.Следующий() Тогда
						_Организация =  Выборка.Организация;
					КонецЕсли;
				Исключение 
					//Сообщить(ОписаниеОшибки());
				КонецПопытки;				
			КонецЕсли;
		Иначе //УТ 10			
			МодульТиповойКонфы = ОбщийМодуль("УправлениеПользователями");
			ТекПользователь = ПараметрыСеанса.ТекущийПользователь;
			//МодульТиповойКонфы2 = ОбщийМодуль("ГлобальныйМодуль");
			//ТекПользователь = МодульТиповойКонфы2.глЗначениеПеременной("глТекущийПользователь");// ИмяПользователя();
			_Организация = МодульТиповойКонфы.ПолучитьЗначениеПоУмолчанию(ТекПользователь,"ОсновнаяОрганизация");
		КонецЕсли 
	ИначеЕсли Метаданные.Имя = "БухгалтерияПредприятия" Тогда 
		Если Версия = "3." Тогда 
			//БП 3.0
			МодульТиповойКонфы = ОбщийМодуль("БухгалтерскийУчетПереопределяемый");
			_Организация = МодульТиповойКонфы.ПолучитьЗначениеПоУмолчанию("ОсновнаяОрганизация");
		Иначе
			// Версия = 2
			МодульТиповойКонфы = ОбщийМодуль("ОбщегоНазначения");
			_Организация = МодульТиповойКонфы.ПолучитьЗначениеПеременной("ОсновнаяОрганизация");
			//_Организация = глЗначениеПеременной("ОсновнаяОрганизация");
			
		КонецЕсли;
		
	ИначеЕсли Метаданные.Имя = "УправлениеПроизводственнымПредприятием" Тогда 		
		//УПП
		МодульТиповойКонфы = ОбщийМодуль("УправлениеПользователями");
		ТекПользователь = ПараметрыСеанса.ТекущийПользователь;
		//МодульТиповойКонфы2 = ОбщийМодуль("ГлобальныйМодуль");
		//МодульТиповойКонфы2.глЗначениеПеременной("глТекущийПользователь");// ИмяПользователя();
		_Организация = МодульТиповойКонфы.ПолучитьЗначениеПоУмолчанию(ТекПользователь,"ОсновнаяОрганизация");
		
	Иначе
		Попытка				
			Если Метаданные.ОбщиеМодули.Найти("БухгалтерскийУчетПереопределяемый") <> Неопределено Тогда
				//БП 3.0
				МодульТиповойКонфы = ОбщийМодуль("БухгалтерскийУчетПереопределяемый");
				_Организация = МодульТиповойКонфы.ПолучитьЗначениеПоУмолчанию("ОсновнаяОрганизация");
			ИначеЕсли Метаданные.ОбщиеМодули.Найти("УправлениеПользователями") <> Неопределено Тогда
				//УПП
				МодульТиповойКонфы = ОбщийМодуль("УправлениеПользователями");
				ТекПользователь = ПараметрыСеанса.ТекущийПользователь;
				//МодульТиповойКонфы2 = ОбщийМодуль("ГлобальныйМодуль");
				//МодульТиповойКонфы2.глЗначениеПеременной("глТекущийПользователь");// ИмяПользователя();							
				_Организация = МодульТиповойКонфы.ПолучитьЗначениеПоУмолчанию(ТекПользователь,"ОсновнаяОрганизация");
			Иначе
				кб99_ВСД.СообщитьИнфо("Для данной конфигурации 1С не удалось получить значение Организации по умолчанию, обратитесь в тех.поддержку КБ99");
			КонецЕсли;
		Исключение
			кб99_ВСД.СообщитьИнфо("Для данной конфигурации 1С не удалось получить значение Организации по умолчанию, обратитесь в тех.поддержку КБ99");
			кб99_ВСД.СообщитьИнфо(ОписаниеОшибки());
		КонецПопытки;
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено( _Организация ) Тогда 
		Запрос = Новый Запрос;
		Запрос.Текст = "ВЫБРАТЬ РАЗРЕШЕННЫЕ ПЕРВЫЕ 2
		               |	Организации.Ссылка КАК Организация
		               |ИЗ
		               |	Справочник.Организации КАК Организации
		               |ГДЕ
		               |	Организации.ПометкаУдаления = ЛОЖЬ";
		Выборка = Запрос.Выполнить().Выбрать();
		Если Выборка.Следующий() Тогда
			_Организация =  Выборка.Организация;
		КонецЕсли;
	КонецЕсли;
	
	Возврат _Организация;
КонецФункции

Функция ПараметрыСервер( ФОбъект ) Экспорт
	
	//Параметры = Новый Соответствие(); // т.к. во всех запросах Параметры = Соответствие()
	Параметры = Новый("Структура");   // Соответсвие ? Структура
	
	//Если НЕ ЗначениеЗаполнено(ФОбъект.КаталогИнтеграции) Тогда 
	//	ФОбъект.КаталогИнтеграции = КаталогПрограммы();
	//	ФОбъект.КаталогЛогов = ФОбъект.КаталогИнтеграции + "logs\";
	//Иначе
	//	Если Прав(ФОбъект.КаталогИнтеграции,1)<>"\" Тогда 
	//		ФОбъект.КаталогИнтеграции = ФОбъект.КаталогИнтеграции+"\";
	//		ФОбъект.КаталогЛогов = ФОбъект.КаталогИнтеграции + "logs\";
	//	КонецЕсли;			
	//КонецЕсли;
	//Если НЕ ЗначениеЗаполнено(Объект.ПолноеИмяФайлаОбработки) Тогда 
	//	Объект.ПолноеИмяФайлаОбработки = Объект.КаталогИнтеграции + "Интеграция_ГИС_Меркурий.epf";
	//КонецЕсли;
	
	Параметры.Вставить("Организация", ФОбъект.Организация );
	
	Параметры.Вставить("КаталогИнтеграции", ФОбъект.КаталогИнтеграции );
	Параметры.Вставить("КаталогЛогов", ФОбъект.КаталогЛогов );
	//Параметры.Вставить("ПолноеИмяФайлаОбработки", ФОбъект.КаталогИнтеграции );
		
	//Параметры.Вставить("ПолноеИмяФайлаОбработки", ФОбъект.ПолноеИмяФайлаОбработки);		
	//Параметры.Вставить("ПолноеИмяФайлаПереопределения", ФОбъект.ПолноеИмяФайлаПереопределения);		
		
	Параметры.Вставить("param_username", ФОбъект.param_username);
	Параметры.Вставить("param_password", ФОбъект.param_password);
	Параметры.Вставить("param_issuer_id", ФОбъект.param_issuer_id);
	Параметры.Вставить("param_service_id", ФОбъект.param_service_id);
	Параметры.Вставить("param_api_key", ФОбъект.param_api_key);
	Параметры.Вставить("param_intiator_login", ФОбъект.param_intiator_login);
	Параметры.Вставить("param_vetdoctor_login", ФОбъект.param_vetdoctor_login);
	Параметры.Вставить("param_vetdoctor_fio", ФОбъект.param_vetdoctor_fio);	
	Параметры.Вставить("param_vetdoctor_post", ФОбъект.param_vetdoctor_post);	
	
	Параметры.Вставить("Отправитель_Площадка", ФОбъект.Отправитель_Площадка);
	Параметры.Вставить("Отправитель_ХозСубъект", ФОбъект.Отправитель_ХозСубъект );
	
	Параметры.Вставить("Страна", ФОбъект.Страна);
	Параметры.Вставить("Регион", ФОбъект.Регион);
	Параметры.Вставить("Город", ФОбъект.Город);
	Параметры.Вставить("ВСД_Экспертиза", ФОбъект.ВСД_Экспертиза);
	Параметры.Вставить("ВСД_Местность", ФОбъект.ВСД_Местность );
	Параметры.Вставить("ВСД_ОсобыеОтметки", ФОбъект.ВСД_ОсобыеОтметки);
	
	Параметры.Вставить("ПаузаСек", ФОбъект.ПаузаСек);	
	Параметры.Вставить("РеквизитГрузополучатель", ФОбъект.РеквизитГрузополучатель);	
			
	Параметры.Вставить("ОтладкаЗапросовXML", ФОбъект.ОтладкаЗапросовXML);	
	Параметры.Вставить("Перевозчик_ХозСубъект", ФОбъект.Перевозчик_ХозСубъект);		
	Параметры.Вставить("ПропускатьПустыеСвойства", ФОбъект.ПропускатьПустыеСвойства);		
	//Параметры.Вставить(НазваниеВидаДокументаРеализация, "НазваниеВидаДокументаРеализация");		
	
	Параметры.Вставить("КаталогЛогов", ФОбъект.КаталогЛогов);
	
	Параметры.Вставить("ВыводитьПодробнуюИнформацию", ФОбъект.ВыводитьПодробнуюИнформацию);	
	
	Параметры.Вставить("Смещение", ФОбъект.Смещение);
	Параметры.Вставить("АвтоЗаписьВСДСоответствия", ФОбъект.АвтоЗаписьВСДСоответствия);
	Параметры.Вставить("НазваниеРеквизитаКоличество", ФОбъект.НазваниеРеквизитаКоличество);
	Параметры.Вставить("ПарамКоэффициентПересчетаКоличества", ФОбъект.ПарамКоэффициентПересчетаКоличества);
	Параметры.Вставить("ВСД_РезультатыИсследований", ФОбъект.ВСД_РезультатыИсследований);
    Параметры.Вставить("ТермическиеУсловияПеревозки", ФОбъект.ТермическиеУсловияПеревозки);
	Параметры.Вставить("ВСДЦель", ФОбъект.ВСДЦель);
	Параметры.Вставить("ПарамЗаполнятьТранзакциюПриОтсутствииПартий", ФОбъект.ПарамЗаполнятьТранзакциюПриОтсутствииПартий);
	Параметры.Вставить("ПарамНомерУровняУпаковкиДляВСД", ФОбъект.ПарамНомерУровняУпаковкиДляВСД);
	Параметры.Вставить("ПарамФормаУпаковкиДляВСД", ФОбъект.ПарамФормаУпаковкиДляВСД);
	Параметры.Вставить("НазваниеРеквизитаКоличествоМест", ФОбъект.НазваниеРеквизитаКоличествоМест);
	Параметры.Вставить("НазваниеРеквизитаКоличествоМест", ФОбъект.НазваниеРеквизитаКоличествоМест);
	//Параметры.Вставить("ОчищатьСправочникВСД_Партии", ФОбъект.ОчищатьСправочникВСД_Партии);
	Параметры.Вставить("ПарамКолонкаСортировкиПартииСписания", ФОбъект.ПарамКолонкаСортировкиПартииСписания);
	Параметры.Вставить("ПарамЗнакСортировкиУбывание", ФОбъект.ПарамЗнакСортировкиУбывание);
	Параметры.Вставить("ПарамФильтроватьРеализациюПоСкладуПлощадкиОтправителя",ФОбъект.ПарамФильтроватьРеализациюПоСкладуПлощадкиОтправителя);	
	
	Параметры.Вставить("ПарамПоставщикОрганизация",ФОбъект.ПарамПоставщикОрганизация);	
	Параметры.Вставить("ПарамПоставщикХозСубъект",ФОбъект.ПарамПоставщикХозСубъект);	
	Параметры.Вставить("ПарамПоставщикПлощадка",ФОбъект.ПарамПоставщикПлощадка);	
	Параметры.Вставить("ПарамРазрешитьВводНаОснованииБолееОдногоВСД",ФОбъект.ПарамРазрешитьВводНаОснованииБолееОдногоВСД);
	
	//Параметры.Вставить("ИспользоватьВнешнююОбработку",ФОбъект.флИспользоватьВнешнююОбработку);
	
	Параметры.Вставить("ОтправлятьВФоне", ФОбъект.ОтправлятьВФоне);
	Параметры.Вставить("ПарамПроизводствоЗаполнятьПоСправочнику", ФОбъект.ПарамПроизводствоЗаполнятьПоСправочнику);
	Параметры.Вставить("ПарамПроизводствоЗаполнятьТчПоТчСерииПродукции", ФОбъект.ПарамПроизводствоЗаполнятьТчПоТчСерииПродукции);
	
	Параметры.Вставить("КодЛицензии", ФОбъект.КодЛицензии);
	Параметры.Вставить("ОтключитьОтправкуСтатистики", ФОбъект.ОтключитьОтправкуСтатистики);
	Параметры.Вставить("ПарамКонтроллироватьСрокГодностиПриОтправке", ФОбъект.ПарамКонтроллироватьСрокГодностиПриОтправке);
	Параметры.Вставить("СрокГодностиДней", ФОбъект.СрокГодностиДней);
	Параметры.Вставить("ПарамКонтроллироватьЗаполнениеУровнейУпаковки", ФОбъект.ПарамКонтроллироватьЗаполнениеУровнейУпаковки);
	Параметры.Вставить("парамПричинаАннулирования", ФОбъект.парамПричинаАннулирования);
	Параметры.Вставить("парамПричинаРасхождения", ФОбъект.парамПричинаРасхождения);
	Параметры.Вставить("парамОписаниеНесоответствия", ФОбъект.парамОписаниеНесоответствия);
	Параметры.Вставить("КоэфПересчетаКоличестваПриПроизводстве", ФОбъект.КоэфПересчетаКоличестваПриПроизводстве);
	Параметры.Вставить("КоличествоДнейХраненияЗапросов",ФОбъект.КоличествоДнейХраненияЗапросов);
	
	Попытка 
		_НастройкиДляТекущегоПользователя = ФОбъект.флСохранятьНастройкиДляТекущегоПользователя; 
	Исключение 
		_НастройкиДляТекущегоПользователя = Ложь; 
	КонецПопытки;
	
	Возврат Параметры;

КонецФункции

// Получает сообщения пользователю, отфильтровывает служебные сообщения о состоянии длительной операции.
// 
// Параметры:
//  УдалятьПолученные - Булево - Признак необходимости удаления полученных сообщений.
//  ИдентификаторЗадания - УникальныйИдентификатор - идентификатор фонового задания.
// 
// Возвращаемое значение:
//  Массив - ФиксированныйМассив - Массив объектов СообщениеПользователю, которые были сформированы в
//  фоновом задании.
// в Бухгалерии 2.0 нет функции СообщенияПользователю в модуле ДлительныеОперации
Функция СообщенияПользователю(УдалятьПолученные = Ложь, ИдентификаторЗадания = Неопределено) Экспорт
	
	Если ЗначениеЗаполнено(ИдентификаторЗадания) Тогда
		ФоновоеЗадание = ФоновыеЗадания.НайтиПоУникальномуИдентификатору(ИдентификаторЗадания);
		Если ФоновоеЗадание <> Неопределено Тогда
			ВсеСообщения = ФоновоеЗадание.ПолучитьСообщенияПользователю(УдалятьПолученные);
		КонецЕсли;
	Иначе
		ВсеСообщения = ПолучитьСообщенияПользователю(УдалятьПолученные);
	КонецЕсли;
	
	Результат = Новый Массив;
	
	Для Каждого Сообщение Из ВсеСообщения Цикл
		//Если СтрНачинаетсяС(Сообщение.Текст, "{" + СообщениеПрогресса() + "}") Тогда
			Если УдалятьПолученные Тогда
				Сообщение.Сообщить();
			КонецЕсли;
		//Иначе
		//	Результат.Добавить(Сообщение);
		//КонецЕсли;
	КонецЦикла;
	
	Возврат Новый ФиксированныйМассив(Результат);
КонецФункции

#Область ЗаполнениеДокументов
Функция ПолучитьНомерДокБезПрефикса(ВыбДок) Экспорт
	Если НЕ(ЗначениеЗаполнено(ВыбДок)) Тогда
		Возврат "";	
	КонецЕсли;
	
	ПереопределенныйМодуль = ФункцияПереопределена("ПолучитьНомерДокБезПрефикса");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ПолучитьНомерДокБезПрефикса( ВыбДок );
	КонецЕсли;

	
	//БП 3.
	
	Если Метаданные.ОбщиеМодули.Найти("ПрефиксацияОбъектовКлиентСервер") <> Неопределено Тогда
		МодульРабота1 = ОбщийМодуль("ПрефиксацияОбъектовКлиентСервер");
		Попытка
			Возврат МодульРабота1.НомерНаПечать(ВыбДок.Номер, Истина, Ложь);
		Исключение
			Возврат МодульРабота1.ПолучитьНомерНаПечать(ВыбДок.Номер, Истина, Ложь);
		КонецПопытки;
	ИначеЕсли Метаданные.ОбщиеМодули.Найти("ОбщегоНазначения") <> Неопределено Тогда
		МодульРабота1 = ОбщийМодуль("ОбщегоНазначения");
		Возврат МодульРабота1.ПолучитьНомерНаПечать(ВыбДок);
	Иначе
		кб99_ВСД.СообщитьИнфо("Для данной конфигурации 1С не удалось ПолучитьНомерДокБезПрефикса");		
		Возврат "";
	КонецЕсли;

//	Возврат ПрефиксацияОбъектовКлиентСервер.НомерНаПечать(ВыбДок.Номер, Истина, Ложь);
	// УПП Воврат ОбщегоНазначения.ПолучитьНомерНаПечать(ВыбДок);
КонецФункции

Функция ПолучитьНомерАвто( ДокОснование ) Экспорт
	
	// Проверка переопределения функции в Общем модуле ВСД_Переопределения
	ПереопределенныйМодуль = ФункцияПереопределена("ПолучитьНомерАвто");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ПолучитьНомерАвто( ДокОснование );
	КонецЕсли;
	
	Попытка
		МетаданныеОбъекта = ДокОснование.Метаданные();
	Исключение 
	    Возврат "Не используется";
	КонецПопытки;
	Если МетаданныеОбъекта.Реквизиты.Найти("Транспорт") <> Неопределено Тогда
		//Это БП ПТФ 2.0
		НомерТС = ДокОснование.Транспорт.ГосНомерАвтомобиля;
		НомерТС = ?(ЗначениеЗаполнено(НомерТС),СокрЛП(НомерТС),"Не исп.");
	ИначеЕсли МетаданныеОбъекта.Реквизиты.Найти("РегистрационныйЗнакАвтомобиля") <> Неопределено Тогда
		//	БП 3
		НомерТС = ?(ЗначениеЗаполнено(ДокОснование.РегистрационныйЗнакАвтомобиля),СокрЛП(ДокОснование.РегистрационныйЗнакАвтомобиля),"Не исп.");
	Иначе	
		Попытка
		// Это УПП и УТ
			Запрос = Новый Запрос;
			Запрос.Текст = "ВЫБРАТЬ 
			| ПараметрыМаршрутаСрезПоследних.Водитель, 
			| ПараметрыМаршрутаСрезПоследних.ЗаказПокупателя, 
			| ПараметрыМаршрутаСрезПоследних.НомерТС 
			|ИЗ 
			| РегистрСведений.ПараметрыМаршрута.СрезПоследних(, ЗаказПокупателя = &ТекЗаказ) КАК ПараметрыМаршрутаСрезПоследних";
		
			Запрос.УстановитьПараметр("ТекЗаказ", ДокОснование.Сделка);
			РезультатЗапроса = Запрос.Выполнить();

			ВыборкаДетальныеЗаписи = РезультатЗапроса.Выбрать();

			Если ВыборкаДетальныеЗаписи.Следующий() Тогда
				//Водитель = ВыборкаДетальныеЗаписи.Водитель;
				НомерТС = ?(ЗначениеЗаполнено(ВыборкаДетальныеЗаписи.НомерТС),ВыборкаДетальныеЗаписи.НомерТС,"Не уст.(Б/Н)");
			Иначе
				//Водитель = Справочники.ФизическиеЛица.ПустаяСсылка();
				НомерТС = "Не исп.";
			КонецЕсли;
		Исключение //КРК - отстутствует регистр сведений ПараметрыМаршрута		
			НомерТС = "Не исп.";	
		КонецПопытки;
	КонецЕсли;
	Возврат НомерТС;
КонецФункции


Функция ЗаполнитьСвязанныеДокументы( ДокВСД ) Экспорт
	ПереопределенныйМодуль = ФункцияПереопределена("ЗаполнитьСвязанныеДокументы");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ЗаполнитьСвязанныеДокументы( ДокВСД );
	КонецЕсли;

КонецФункции

// Работа с документами
Функция РассчитатьКоличествоДляВСД( ПараметрыОрганизации, СтрокаТЧДок, Продукция_Элемент = "") Экспорт
	// вызов переопределения
	ПереопределенныйМодуль = ФункцияПереопределена("РассчитатьКоличествоДляВСД");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.РассчитатьКоличествоДляВСД( ПараметрыОрганизации, СтрокаТЧДок, Продукция_Элемент );
	КонецЕсли;
	
	Рез = 0;
	Коэфф = 0;
	Попытка
		//Пересчет ШТ в КГ
		Версия = Лев(Метаданные.Версия,2);		
		Если Метаданные.Имя = "УправлениеТорговлей" И Версия="11" Тогда 				
			Если СтрокаТЧДок.Номенклатура.ВесИспользовать Тогда
				Если СтрокаТЧДок.Номенклатура.ВесЗнаменатель>0 Тогда 
					Коэфф=СтрокаТЧДок.Номенклатура.ВесЧислитель/СтрокаТЧДок.Номенклатура.ВесЗнаменатель;
				Иначе
					Коэфф=0;
				КонецЕсли;
			КонецЕсли;
		Иначе //остальные считаем с учетом параметра [ПарамКоэффициентПересчетаКоличества]		
			
			КПересчета = ПараметрыОрганизации["ПарамКоэффициентПересчетаКоличества"]; 
			Попытка
				Коэфф = Число(КПересчета);
			Исключение
				Коэфф = 0;
			КонецПопытки;
						
			Если НЕ(ЗначениеЗаполнено(КПересчета)) Тогда
				Коэфф = 1;
			ИначеЕсли Строка(Коэфф)	= КПересчета Тогда
				Коэфф = Число(КПересчета);
			Иначе //реквизитСтрокиДока.
				_Точка = Найти(КПересчета,".");
				ИмяРекв = Сред(КПересчета,1,_Точка-1);
				ИмяПодРекв = Сред(КПересчета,_Точка+1);
				Коэфф = СтрокаТЧДок[ИмяРекв];
				_Точка = Найти(ИмяПодРекв,".");
				Пока _Точка > 0 Цикл
					ИмяРекв = Сред(ИмяПодРекв,1,_Точка-1);
					ИмяПодРекв = Сред(ИмяПодРекв,_Точка+1);
					Коэфф = Коэфф[ИмяРекв];
					_Точка = Найти(ИмяПодРекв,".");
				КонецЦикла;
				Если НЕ ТипЗнч(Коэфф) = Тип("Число") Тогда
					Коэфф = Коэфф[ИмяПодРекв];
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
	Исключение
		кб99_ВСД.СообщитьИнфо("Указан неверный параметр [ПарамКоэффициентПересчетаКоличества]");
		кб99_ВСД.СообщитьИнфо(ОписаниеОшибки());
		Рез = 0;
	КонецПопытки;
		
	Если Коэфф = 0 Тогда
		кб99_ВСД.СообщитьИнфо("Коэфф пересчета "+КПересчета+" для "+СтрокаТЧДок.Номенклатура + " равен 0 - ставлю 1" );
		Коэфф = 1;
	КонецЕсли;
	
	Попытка
		Рез = СтрокаТЧДок[ ПараметрыОрганизации["НазваниеРеквизитаКоличество"] ]*Коэфф;
	Исключение
		кб99_ВСД.СообщитьИнфо("Указан неверный параметр [НазваниеРеквизитаКоличество] ");
		кб99_ВСД.СообщитьИнфо(ОписаниеОшибки());
		Рез = 0;
	КонецПопытки;
	
	Возврат Рез;
КонецФункции

Функция ВыгрузитьТч( Док, ПараметрыОрганизации="" ) Экспорт
//// вызов переопределения
	ПереопределенныйМодуль = ФункцияПереопределена("ВыгрузитьТч");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ВыгрузитьТч( Док, ПараметрыОрганизации );
	КонецЕсли;
	
	Если НЕ ЗначениеЗаполнено(ПараметрыОрганизации) Тогда 
		ПараметрыОрганизации = кб99_ВСД.ЗагрузитьПараметры( Док.Организация );
	КонецЕсли;
	
	тзРез = Новый("ТаблицаЗначений");
	тзРез.Колонки.Добавить("Номенклатура");
	тзРез.Колонки.Добавить("Продукция_Элемент");
	тзРез.Колонки.Добавить("Количество");
	тзРез.Колонки.Добавить("Упаковки");
	тзРез.Колонки.Добавить("СерияНоменклатуры");
	тзРез.Колонки.Добавить("ТермУсловияПеревозки");
	
	Для Каждого стрДок Из док.Товары Цикл
		ВСДПродукцияЭлемент = кб99_ВСД.Продукция_Элемент_ПолучитьПоНоменклатуре(стрДок.Номенклатура);
		Если (ВСДПродукцияЭлемент = Справочники.ВСД_Продукция_Элемент.ПустаяСсылка()) и НЕ( ПараметрыОрганизации["ПропускатьПустыеСвойства"] ) Тогда
			кб99_ВСД.СообщитьИнфо("["+стрДок.Номенклатура+"] -> не указан ВСД_Продукция_Элемент");
		ИначеЕсли (ВСДПродукцияЭлемент=Справочники.ВСД_Продукция_Элемент.ПустаяСсылка()) и ( ПараметрыОрганизации["ПропускатьПустыеСвойства"] ) Тогда
			Продолжить;
		КонецЕсли;
		СтрТЧ = тзРез.Добавить();
		СтрТЧ.Номенклатура = стрДок.Номенклатура;
		СтрТЧ.Продукция_Элемент = ВСДПродукцияЭлемент;
		СтрТЧ.Количество = РассчитатьКоличествоДляВСД(ПараметрыОрганизации, стрДок, ВСДПродукцияЭлемент);
		Попытка СтрТЧ.СерияНоменклатуры = стрДок.СерияНоменклатуры; Исключение КонецПопытки; //преобразовать дату в строку
		Если ЗначениеЗаполнено(ВСДПродукцияЭлемент.ТермическиеУсловияПеревозки) Тогда
			ТермУсловияПеревозки = ВСДПродукцияЭлемент.ТермическиеУсловияПеревозки;
		Иначе
			ТермУсловияПеревозки =  ПараметрыОрганизации["ТермическиеУсловияПеревозки"];
		КонецЕсли;
		СтрТЧ.ТермУсловияПеревозки = ТермУсловияПеревозки;
		Попытка
			Если ЗначениеЗаполнено(стрДок[ ПараметрыОрганизации["НазваниеРеквизитаКоличествоМест"] ]) Тогда
				СтрТЧ.Упаковки = стрДок[ ПараметрыОрганизации["НазваниеРеквизитаКоличествоМест"] ];
			КонецЕсли;
		Исключение КонецПопытки;
	КонецЦикла;
	Возврат тзРез;
КонецФункции

//Функция ЗаполнитьТабЧастьЭлементовДляСозданияВСД(ПараметрыОрганизации, тзПартии, ДокОсн = Неопределено ) Экспорт
Функция ЗаполнитьТабЧастьВсдПоПартиям( ПараметрыОрганизации, тзПартии, ДокОсн = Неопределено ) Экспорт
	
	ПереопределенныйМодуль = ФункцияПереопределена("ЗаполнитьТабЧастьВсдПоПартиям");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ЗаполнитьТабЧастьВсдПоПартиям( ПараметрыОрганизации, тзПартии, ДокОсн );
	КонецЕсли;
	
 	// Данные из таблицы Партии по недостающим к реализации
	// либо из докОснования - ВыгрузитьТЧ выполняется
	РезТаб = Новый ТаблицаЗначений;
	РезТаб.Колонки.Добавить("Номенклатура",новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	РезТаб.Колонки.Добавить("Продукция_Элемент",новый ОписаниеТипов("СправочникСсылка.ВСД_Продукция_Элемент"));
	РезТаб.Колонки.Добавить("Количество",новый ОписаниеТипов("Число"));
	РезТаб.Колонки.Добавить("Упаковки"); // для совместимости с ВыгрузитьТЧ
	Если Докосн = Неопределено Тогда
		Для Каждого стрПартии Из тзПартии Цикл
			Если НЕ(ЗначениеЗаполнено(стрПартии.Продукция_Элемент)) Тогда
				Продолжить;	
			КонецЕсли;
			Если (стрПартии.КоличествоСписания - стрПартии.Количество) <= 0 Тогда 
				Продолжить; //пропустим то что есть в наличии				
			КонецЕсли;			
			стрТаб = Резтаб.Добавить();
			стрТаб.Продукция_Элемент = стрПартии.Продукция_Элемент;
			стрТаб.Количество = стрПартии.КоличествоСписания - стрПартии.Количество;
		КонецЦикла;
	иначеЕсли ТипЗнч(ДокОсн) = Тип("ДокументСсылка.ВСД2_транзакция") Тогда		
		Для Каждого строкаДок Из Докосн.Товары  Цикл
			стрТаб = Резтаб.Добавить();
			стрТаб.Номенклатура = строкаДок.Номенклатура;
			Если ЗначениеЗаполнено(строкаДок.Продукция_Элемент) Тогда 
				стрТаб.Продукция_Элемент = строкаДок.Продукция_Элемент
			Иначе
				стрТаб.Продукция_Элемент = кб99_ВСД.Продукция_Элемент_ПолучитьПоНоменклатуре(строкаДок.Номенклатура);
			КонецЕсли;
			стрТаб.Количество = строкаДок.Количество;			
		КонецЦикла
	Иначе
		// возьмем реализацию тогда за Основу...
		Возврат ВыгрузитьТЧ(ДокОсн, ПараметрыОрганизации);
	КонецЕсли;
	
	Возврат резТаб;
КонецФункции

//Функция ЗаполнитьТабЧастьЭлементовДляСозданияВСД(ПараметрыОрганизации, тзПартии, ДокОсн = Неопределено ) Экспорт
Функция ЗаполнитьТабЧастьВсдПоОснованию(ПараметрыОрганизации, ДокОсн ) Экспорт
	
	ПереопределенныйМодуль = ФункцияПереопределена("ЗаполнитьТабЧастьВсдПоОснованию");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ЗаполнитьТабЧастьВсдПоОснованию( ПараметрыОрганизации, ДокОсн );
	КонецЕсли;
	
 	// Данные из таблицы Партии по недостающим к реализации
	// либо из докОснования - ВыгрузитьТЧ выполняется
	РезТаб = Новый ТаблицаЗначений;
	РезТаб.Колонки.Добавить("Номенклатура",новый ОписаниеТипов("СправочникСсылка.Номенклатура"));
	РезТаб.Колонки.Добавить("Продукция_Элемент",новый ОписаниеТипов("СправочникСсылка.ВСД_Продукция_Элемент"));
	РезТаб.Колонки.Добавить("Количество",новый ОписаниеТипов("Число"));
	РезТаб.Колонки.Добавить("Упаковки"); // для совместимости с ВыгрузитьТЧ
	//Если Докосн = Неопределено Тогда
	//	для каждого стрПартии из тзПартии Цикл
	//		Если НЕ(ЗначениеЗаполнено(стрПартии.ВСД_Продукция_Элемент)) тогда
	//			Продолжить;	
	//		КонецЕсли;
	//		Если (стрПартии.КоличествоСписания - стрПартии.Количество) <= 0 Тогда 
	//			Продолжить; //пропустим то что есть в наличии				
	//		КонецЕсли;			
	//		стрТаб = Резтаб.Добавить();
	//		стрТаб.Продукция_Элемент = стрПартии.ВСД_Продукция_Элемент;
	//		стрТаб.Количество = стрПартии.КоличествоСписания - стрПартии.Количество;
	//	КонецЦикла;
	Если ТипЗнч(ДокОсн) = Тип("ДокументСсылка.ВСД2_транзакция") Тогда		
		Для Каждого строкаДок Из Докосн.Товары  Цикл
			стрТаб = Резтаб.Добавить();
			стрТаб.Номенклатура = строкаДок.Номенклатура;
			Если ЗначениеЗаполнено(строкаДок.Продукция_Элемент) Тогда 
				стрТаб.Продукция_Элемент = строкаДок.Продукция_Элемент
			Иначе
				стрТаб.Продукция_Элемент = кб99_ВСД.Продукция_Элемент_ПолучитьПоНоменклатуре(строкаДок.Номенклатура);
			КонецЕсли;
			стрТаб.Количество = строкаДок.Количество;			
		КонецЦикла
	Иначе
		// возьмем реализацию тогда за Основу...
		Возврат ВыгрузитьТЧ(ДокОсн, ПараметрыОрганизации);
	КонецЕсли;
	
	Возврат резТаб;
КонецФункции

Функция ПолучитьДанныеДляСозданияВСДПеремещения(ПараметрыОраганизации, тзПартии, ДокОсн ) Экспорт
    Рез = Новый Структура;
	Рез.Вставить("Организация", ПараметрыОраганизации["ПарамПоставщикОрганизация"]);
	Рез.Вставить("Отправитель_Хозсубъект", ПараметрыОраганизации["ПарамПоставщикХозСубъект"]);
	Рез.Вставить("Отправитель_Площадка", ПараметрыОраганизации["ПарамПоставщикПлощадка"]);
	Рез.Вставить("Получатель_Хозсубъект", ПараметрыОраганизации["Отправитель_Хозсубъект"]);
	Рез.Вставить("Получатель_Площадка", ПараметрыОраганизации["Отправитель_Площадка"]);
	Рез.Вставить("ДокОснование", ПараметрыОраганизации["ДокОсн"]);
	//Рез.Вставить("СтрокиВСД", ЗаполнитьТабЧастьЭлементовДляСозданияВСД(тзПартии, тзПартии, ДокОсн));
	Рез.Вставить("СтрокиВСД", ЗаполнитьТабЧастьВсдПоПартиям(тзПартии, тзПартии, ДокОсн));
	
	Возврат Рез;
КонецФункции

Функция ПолучитьАртикулНоменклатуры( ПараметрыОрганизации, НоваяСтрока, СтрокаОснования, ДокСсылка)
	
	ПереопределенныйМодуль = ФункцияПереопределена("ПолучитьАртикулНоменклатуры");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ПолучитьАртикулНоменклатуры( ПараметрыОрганизации, НоваяСтрока, СтрокаОснования, ДокСсылка );
	КонецЕсли;
	
	Ответ = НоваяСтрока.Продукция_Элемент.Артикул;
	Возврат Ответ;
КонецФункции

Функция ЗаполнитьРеквизитыСтрокиВСД( ПараметрыОрганизации, НоваяСтрока, СтрокаОснования, ДокСсылка ) Экспорт
	
//// вызов переопределения	
	ПереопределенныйМодуль = ФункцияПереопределена("ЗаполнитьРеквизитыСтрокиВСД");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ЗаполнитьРеквизитыСтрокиВСД( ПараметрыОрганизации, НоваяСтрока, СтрокаОснования, ДокСсылка );
	КонецЕсли;
	
//	НоваяСтрока.Номенклатура 			= СтрокаОснования.Номенклатура;
//	НоваяСтрока.Продукция_Элемент 		= СтрокаОснования.Продукция_Элемент;
//	НоваяСтрока.ЕдиницаИзмерения 		= НоваяСтрока.Партия.ЕдиницаИзмерения;
	// 
	Попытка
		НоваяСтрока.Продукция 				= НоваяСтрока.Продукция_Элемент.Продукция;
		НоваяСтрока.ВидПродукции 			= НоваяСтрока.Продукция_Элемент.ВидПродукции;
		НоваяСтрока.НаименованиеПродукции 	= НоваяСтрока.Продукция_Элемент.Наименование;
	Исключение КонецПопытки;
	
	Попытка НоваяСтрока.ВидПроисхожденияНеПищевойПродукции	= НоваяСтрока.Продукция_Элемент.ВидПроисхожденияНеПищевойПродукции Исключение КонецПопытки;
	Попытка НоваяСтрока.РезультатыИсследований	= НоваяСтрока.Партия.vetDocument.РезультатыИсследований Исключение КонецПопытки;
	Попытка НоваяСтрока.GTIN = НоваяСтрока.Продукция_Элемент.GTIN; Исключение КонецПопытки;
	Попытка НоваяСтрока.Артикул	= ПолучитьАртикулНоменклатуры( ПараметрыОрганизации, НоваяСтрока, СтрокаОснования, ДокСсылка) Исключение КонецПопытки;
	Попытка НоваяСтрока.КлючСтроки	= Новый УникальныйИдентификатор() Исключение КонецПопытки;

	Попытка
		НоваяСтрока.Цель 					= НоваяСтрока.Продукция_Элемент.ВидПродукции.Цель;
		Если НЕ ЗначениеЗаполнено(НоваяСтрока.Цель) Тогда 
			НоваяСтрока.Цель = ПараметрыОрганизации["ВСДЦель"];
		КонецЕсли;
	Исключение КонецПопытки;
	
	Если докСсылка.Метаданные().ТабличныеЧасти.Найти("УровниУпаковки") <> Неопределено Тогда
		Если НЕ(ЗначениеЗаполнено( ПараметрыОрганизации["ПарамНомерУровняУпаковкиДляВСД"] )) или НЕ(ЗначениеЗаполнено( ПараметрыОрганизации["ПарамФормаУпаковкиДляВСД"])) Тогда
			//СообщитьИнфо("Не аполнены Параметры для упаковки на уровнях");
			Возврат "";	
		КонецЕсли;
	// Упаковка на уровнях
		Попытка
		
			Если ЗначениеЗаполнено(СтрокаОснования.Упаковки) Тогда
				Если Цел(СтрокаОснования.Упаковки/СтрокаОснования.Количество*НоваяСтрока.Количество) = 0 Тогда
					кб99_ВСД.СообщитьИнфо("Нулевое кол-во упаковки у "+СтрокаОснования.Продукция_Элемент+" в "+ДокСсылка);	
				Иначе
			    	СтрокаУпак = докСсылка.УровниУпаковки.Добавить(); //Документы.ВСД2_транзакция.СоздатьДокумент().УровниУпаковки.Добавить();
					СтрокаУпак.СтрокаПродукции = НоваяСтрока.КлючСтроки;
					СтрокаУпак.Количество = Цел(СтрокаОснования.Упаковки/СтрокаОснования.Количество*НоваяСтрока.Количество); //Пропорционально Распределенному количеству
					СтрокаУпак.НомерУровня = ПараметрыОрганизации["ПарамНомерУровняУпаковкиДляВСД"];//СписокПараметров.Получить("ПарамНомерУровняУпаковкиДляВСД");
					СтрокаУпак.ФормаУпаковки = ПараметрыОрганизации["ПарамФормаУпаковкиДляВСД"];//СписокПараметров.Получить("ПарамФормаУпаковкиДляВСД");;
					//Маркировки
		//			СтрокаМарк = докСсылка.Маркировка.Добавить();
		//			СтрокаМарк.Строкапродукции = СтрокаУпак.СтрокаПродукции;
		//			СтрокаМарк.НомерУровня = СтрокаУпак.НомерУровня;
		//			СтрокаМарк.Класс = Перечисления.ВСД_Маркировка.BN;
		//			СтрокаМарк.Маркировка = "ТЕСТ";  //ПолучитьМаркировку( ТЗПартий.Номенклатура.ОсновнаяЕдиница, Контрагент);
				КонецЕсли;
			КонецЕсли;
		Исключение 
			кб99_ВСД.СообщитьИнфо(ОписаниеОшибки());	
		КонецПопытки;
	КонецЕсли;
	
КонецФункции

//Процедура ЗаполнитьТЧВСД(ПараметрыОрганизации, ДанныеЗаполнения = Неопределено, докСсылка, тзАктуальныхПартий = Неопределено) Экспорт
Функция ЗаполнитьТабЧастьВСД( ПараметрыОрганизации, ДанныеЗаполнения = Неопределено, докСсылка, тзАктуальныхПартий = Неопределено) Экспорт
// заполняет ТЧ документа ВСД по Входящим данным , вызывается из ЗаполнитьНаосновании ВСД2_Транзакция
// ДанныеЗаполнения = Документ основание, берем из него ТЧ для расчета Кол-ва и Продэлементы для фильтра партий,
// также данные для заполнения Маркировок

// Добавлен реквизит - тзЭлементыОснования = ТЧ докоснования, для подбора Партий без Документа Основания

	// вызов переопределения
	ПереопределенныйМодуль = ФункцияПереопределена("ЗаполнитьТабЧастьВСД");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ЗаполнитьТабЧастьВСД( ПараметрыОрганизации, ДанныеЗаполнения, докСсылка, тзАктуальныхПартий );
	КонецЕсли;

	Если ЗначениеЗаполнено( ДанныеЗаполнения ) Тогда
		тзЭлементыОснования = ВыгрузитьТЧ(ДанныеЗаполнения.Ссылка, ПараметрыОрганизации ); 		
	КонецЕсли;
	
	Если докСсылка.Получатель_ХозСубъект.ПерсональныеПараметрыСписанияПартий Тогда 
		ПолеСортировкиПокупателя = докСсылка.Получатель_ХозСубъект.ПарамКолонкаСортировкиПартииСписания;
		ЗнакСортировкиПокупателя = докСсылка.Получатель_ХозСубъект.ПарамЗнакСортировкиУбывание;
	Иначе 
		ПолеСортировкиПокупателя = Неопределено;
		ЗнакСортировкиПокупателя = Неопределено;
	КонецЕсли;
	ПартииКСписанию = кб99_ВСД.тзПартииСписанияПоТзПродукция_Элемент( ПараметрыОрганизации, тзЭлементыОснования, тзАктуальныхПартий, ПолеСортировкиПокупателя, ЗнакСортировкиПокупателя  );
	
	Если (ПартииКСписанию.Количество() = 0) и НЕ(ПараметрыОрганизации["ПарамЗаполнятьТранзакциюПриОтсутствииПартий"]) Тогда
		кб99_ВСД.СообщитьИнфо("Нет актуальных партий для создания ВСД по "+ ?(ДанныеЗаполнения = Неопределено,"Переданным данным",ДанныеЗаполнения.Ссылка));
		Возврат Ложь;
	КонецЕсли;
	
	Для Каждого ТекСтрокаТовары Из ПартииКСписанию Цикл
		НоваяСтрока = докСсылка.Товары.Добавить();
		ЗаполнитьЗначенияСвойств(НоваяСтрока,ТекСтрокаТовары);
		ЗаполнитьРеквизитыСтрокиВСД(ПараметрыОрганизации, НоваяСтрока, ТекСтрокаТовары, докСсылка);
		//Если ЗначениеЗаполнено (ТекСтрокаТовары.Продукция_Элемент) Тогда
			//докСсылка.ТермическоеСостояние = МИН(ТекСтрокаТовары.Продукция_Элемент.ТермическиеУсловияПеревозки,докСсылка.ТермическоеСостояние) ;
			//ДокВСД.ТермическиеУсловияПеревозки = ПараметрыОрганизации["ТермическиеУсловияПеревозки")
		//КонецЕсли;
	КонецЦикла;
	//докСсылка.ТермическоеСостояние = ?(докСсылка.ТермическоеСостояние=0,1,докСсылка.ТермическоеСостояние); //!!!!
КонецФункции

// тзЭлементыОснования = входящая ТаблицаЗначений :
//тзЭлементыОснования = Новый("ТаблицаЗначений");
//тзЭлементыОснования.Колонки.Добавить("Номенклатура");
//тзЭлементыОснования.Колонки.Добавить("Продукция_Элемент");
//тзЭлементыОснования.Колонки.Добавить("Количество");
//тзЭлементыОснования.Колонки.Добавить("Упаковки");
Функция ЗаполнитьТабЧастьВСДпоТЗ( ПараметрыОрганизации, тзЭлементыОснования, докСсылка, тзАктуальныхПартий = Неопределено) Экспорт
// заполняет ТЧ документа ВСД по Входящим данным , вызывается из ЗаполнитьНаосновании ВСД2_Транзакция
// ДанныеЗаполнения = Документ основание, берем из него ТЧ для расчета Кол-ва и Продэлементы для фильтра партий,
// также данные для заполнения Маркировок

	// вызов переопределения
	ПереопределенныйМодуль = ФункцияПереопределена("ЗаполнитьТабЧастьВСДпоТЗ");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.ЗаполнитьТабЧастьВСДпоТЗ( ПараметрыОрганизации, тзЭлементыОснования, докСсылка, тзАктуальныхПартий );
	КонецЕсли;

	//Если ЗначениеЗаполнено( ДанныеЗаполнения ) тогда
	//	тзЭлементыОснования = ВыгрузитьТЧ(ДанныеЗаполнения.Ссылка, ПараметрыОрганизации ); 		
	//КонецЕсли;
	
	Если докСсылка.Получатель_ХозСубъект.ПерсональныеПараметрыСписанияПартий Тогда 
		ПолеСортировкиПокупателя = докСсылка.Получатель_ХозСубъект.ПарамКолонкаСортировкиПартииСписания;
		ЗнакСортировкиПокупателя = докСсылка.Получатель_ХозСубъект.ПарамЗнакСортировкиУбывание;
	Иначе 
		ПолеСортировкиПокупателя = Неопределено;
		ЗнакСортировкиПокупателя = Неопределено;
	КонецЕсли;
	ПартииКСписанию = кб99_ВСД.тзПартииСписанияПоТзПродукция_Элемент( ПараметрыОрганизации, тзЭлементыОснования, тзАктуальныхПартий, ПолеСортировкиПокупателя, ЗнакСортировкиПокупателя  );
	
	Если (ПартииКСписанию.Количество() = 0) и НЕ(ПараметрыОрганизации["ПарамЗаполнятьТранзакциюПриОтсутствииПартий"]) Тогда
		кб99_ВСД.СообщитьИнфо("Нет актуальных партий для создания ВСД ", тзЭлементыОснования );
		Возврат Ложь;
	КонецЕсли;
	
	Для Каждого ТекСтрокаТовары Из ПартииКСписанию Цикл
		НоваяСтрока = докСсылка.Товары.Добавить();			
		ЗаполнитьЗначенияСвойств(НоваяСтрока,ТекСтрокаТовары);
		ЗаполнитьРеквизитыСтрокиВСД(ПараметрыОрганизации, НоваяСтрока, ТекСтрокаТовары, докСсылка);
		//Если ЗначениеЗаполнено (ТекСтрокаТовары.Продукция_Элемент) Тогда
			//докСсылка.ТермическоеСостояние = МИН(ТекСтрокаТовары.Продукция_Элемент.ТермическиеУсловияПеревозки,докСсылка.ТермическоеСостояние) ;
			//ДокВСД.ТермическиеУсловияПеревозки = ПараметрыОрганизации["ТермическиеУсловияПеревозки")
		//КонецЕсли;
	КонецЦикла;
	//докСсылка.ТермическоеСостояние = ?(докСсылка.ТермическоеСостояние=0,1,докСсылка.ТермическоеСостояние); //!!!!
КонецФункции


#КонецОбласти

#Область ПереопределениеФункций

Функция ФункцияПереопределена( ИмяФункции ) Экспорт
 
 	// Проверка переопределения функции в Общем модуле ВСД_Переопределения
 	Модуль  = ОбщийМодуль("кб99_ВСД_Переопределения");
	Если Модуль = Неопределено Тогда
		Возврат Неопределено;
 	КонецЕсли;  
	
	Если Модуль.НайтиФункцию( ИмяФункции ) Тогда 
		Возврат Модуль;
	Иначе
		// переопределения нет
		Возврат Неопределено;
	КонецЕсли;
	
КонецФункции

#КонецОбласти 

#Область ЗаполнениеТаблицыОтгрузок
// ================ Заполнение табличной части ============================

&НаСервере
// Функция СформироватьЗапрос(Организации = Неопределено, ПлощадкаОтправителя = Неопределено, ДатаНачала, ДатаОкончания) Экспорт
Функция ПолучитьТзРеализаций( ПараметрыФункции ) Экспорт
	ПереопределенныйМодуль = ФункцияПереопределена("ПолучитьТзРеализаций");
	Если ПереопределенныйМодуль <> Неопределено Тогда		
		Возврат ПереопределенныйМодуль.ПолучитьТзРеализаций( ПараметрыФункции );
	КонецЕсли;	
	
	// ЖД добавлена фильтрация Реализации по Складу отправителю (=текущая ПлощадкаОтправителя.Склад)
    // м.б. при незаполненном реквизите Склад у Площадки не фильтровать по складу ????
    Запрос = Новый Запрос;
    Запрос.УстановитьПараметр("ДатаНачала", ПараметрыФункции["ДатаНачала"] );
    Запрос.УстановитьПараметр("ДатаОкончания", ПараметрыФункции["ДатаОкончания"] );

    Запрос.УстановитьПараметр("СписокОрганизаций", ПараметрыФункции["Организации"]);
//    Попытка Запрос.УстановитьПараметр("ПлощадкаОтправителяСклад",    ПлощадкаОтправителя.Склад); Исключение КонецПопытки;
    Если ПараметрыФункции["ПарамФильтроватьРеализациюПоСкладуПлощадкиОтправителя"] Тогда
        Попытка 
            Запрос.УстановитьПараметр("ПлощадкаОтправителяСклад",    ПараметрыФункции["ПлощадкаОтправителя"].Склад );
            Если НЕ(ЗначениеЗаполнено( ПараметрыФункции["ПлощадкаОтправителя"].Склад ) ) Тогда
                кб99_ВСД.СообщитьИнфо("Не определен Склад по Площадке "+ПараметрыФункции["ПлощадкаОтправителя"]+" привяжите склад к площадке либо отключите параметр [Фильтровать Реализацию По Складу Площадки Отправителя]!");    
            КонецЕсли;
        Исключение 
            Запрос.УстановитьПараметр("ПлощадкаОтправителяСклад", ""); 
            кб99_ВСД.СообщитьИнфо("Не определен Склад по Площадке для фильтрации документов!"); 
        КонецПопытки;    
    КонецЕсли;

    Попытка Запрос.УстановитьПараметр("ВыбМаршрут", ПараметрыФункции["Маршрут"] ); Исключение КонецПопытки;

    Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;

    Запрос.Текст =
    "ВЫБРАТЬ
    |    РеализацияТоваровУслуг.Ссылка КАК Док,
    |    @Грузополучатель@ КАК Грузополучатель,
    |    РеализацияТоваровУслуг.Контрагент.ГоловнойКонтрагент КАК Контрагент,
    |    СУММА(РеализацияТоваровУслугТовары.@КоличествоМест@) КАК КоличествоМест,
    |    СУММА( РеализацияТоваровУслугТовары.@Количество@ ) КАК Количество,
    |    ЗапросПлощадки.ВСД_Площадка КАК Площадка,
    |    ВСД_ХозСубъект.Ссылка КАК ХозСубъект,	
    |    СУММА(РеализацияТоваровУслугТовары.Сумма) КАК Сумма,
    |    ЗапросВСД.Ссылка КАК ВСД,
    |    @Маршрут@
    |    РеализацияТоваровУслуг.Номер КАК Номер,
    |    РеализацияТоваровУслуг.Дата КАК Дата
    |ИЗ
    |    Документ.РеализацияТоваровУслуг КАК РеализацияТоваровУслуг
    |        ЛЕВОЕ СОЕДИНЕНИЕ (
		|		ВЫБРАТЬ
	    |            ВСД_транзакция.Ссылка КАК Ссылка,
	    |            ВСД_транзакция.ДокументОснование КАК ДокОснование
	    |        ИЗ
	    |            Документ.ВСД_транзакция КАК ВСД_транзакция
	    |        ГДЕ
	    |            ВСД_транзакция.ПометкаУдаления = ЛОЖЬ	
	    |        ОБЪЕДИНИТЬ ВСЕ
	    |        ВЫБРАТЬ
	    |            ВСД2_транзакция.Ссылка,
	    |            ВСД2_транзакция.ДокументОснование
	    |        ИЗ
	    |            Документ.ВСД2_транзакция КАК ВСД2_транзакция
	    |        ГДЕ
	    |            ВСД2_транзакция.ПометкаУдаления = ЛОЖЬ
		|            И ВСД2_транзакция.ЭтоПеремещениеОтПоставщика = ЛОЖЬ) КАК ЗапросВСД
    |        ПО (ЗапросВСД.ДокОснование = РеализацияТоваровУслуг.Ссылка)
	|        ЛЕВОЕ СОЕДИНЕНИЕ (
		|		ВЫБРАТЬ
		|			ВСД_ХозСубъект.Ссылка КАК ХС,
		|			ВСД_ХозСубъект.Контрагент КАК КонтрагентХС,
	    |           ВСД_Площадка.Ссылка КАК ВСД_Площадка,
		|			ВСД_Площадка.Контрагент КАК Контрагент
	    |        ИЗ
		|            Справочник.ВСД_ХозСубъект КАК ВСД_ХозСубъект
		|        ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВСД_Площадка КАК ВСД_Площадка
		// |	 		ПО ВСД_Площадка.GuidХозСубъекта = ВСД_ХозСубъект.GUID
		|	 		ПО ВСД_Площадка.ХозСубъект = ВСД_ХозСубъект.Ссылка
		|			И ВСД_Площадка.ПометкаУдаления = ЛОЖЬ	
		|		ГДЕ 
		|		 	ВСД_ХозСубъект.ПометкаУдаления = ЛОЖЬ
		|		 	И НЕ ВСД_ХозСубъект.Контрагент ЕСТЬ NULL
		|		) КАК ЗапросПлощадки
		|		ПО @Грузополучатель_Связи@
		|        И РеализацияТоваровУслуг.Контрагент.ГоловнойКонтрагент = ЗапросПлощадки.КонтрагентХС
		|        И НЕ ( РеализацияТоваровУслуг.Контрагент.ГоловнойКонтрагент ЕСТЬ NULL )
	|
	|
	|
	|        ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВСД_ХозСубъект КАК ВСД_ХозСубъект
	|        	ПО РеализацияТоваровУслуг.Контрагент.ГоловнойКонтрагент = ВСД_ХозСубъект.Контрагент
	|			И ВСД_ХозСубъект.ПометкаУдаления = ЛОЖЬ
	|    @Отбор_по_НоменклатураСоответствия@
    |ГДЕ
    |    РеализацияТоваровУслуг.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	|    И РеализацияТоваровУслуг.Проведен = Истина
    |    И РеализацияТоваровУслугТовары.Сумма > 0
    |    И РеализацияТоваровУслуг.Организация В ИЕРАРХИИ(&СписокОрганизаций)
    |    @Отбор_по_Складам@
    |    @Маршрут_Условие@
    |
    |СГРУППИРОВАТЬ ПО
    |    РеализацияТоваровУслуг.Ссылка,
    |    @Грузополучатель_Группировка@
    |    РеализацияТоваровУслуг.Контрагент.ГоловнойКонтрагент,
    |    ЗапросПлощадки.ВСД_Площадка,
	| 	 ВСД_ХозСубъект.Ссылка,
    |    ЗапросВСД.Ссылка,
    |    РеализацияТоваровУслуг.Номер,
    |    РеализацияТоваровУслуг.Дата
    |УПОРЯДОЧИТЬ ПО
    |    Дата,
    |    Номер";

	// @	
	Если ПараметрыФункции["ПропускатьПустыеСвойства"] Тогда
		ТекстОтбор = "
			|ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
			|	(ВЫБРАТЬ
				|	ДокСтроки1.Ссылка КАК Ссылка,
		        |	ДокСтроки1.Номенклатура КАК Номенклатура,
		        |	ЗапросТовары.ПродукцияЭлемент КАК ПродукцияЭлемент,				
		        |	(ДокСтроки1.@Количество@ * @КоэффициентПересчета@ ) КАК @Количество@,
				//|	ДокСтроки1.@КоличествоМест@ КАК @КоличествоМест@,    //Раскоментировать если реквизиты Количество и КоличествоМест различные
				|	ДокСтроки1.Сумма КАК Сумма
		        |ИЗ
		        |	Документ.РеализацияТоваровУслуг.Товары КАК ДокСтроки1
		        |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		        |			Спр1.ПродукцияЭлемент КАК ПродукцияЭлемент,
		        |			Спр1.Владелец КАК Номенклатура
		        |		ИЗ
		        |			Справочник.ВСД_Соответсвия КАК Спр1
		        |		ГДЕ
		        |			НЕ Спр1.ПродукцияЭлемент ЕСТЬ NULL
				|			И Спр1.ПометкаУдаления = ЛОЖЬ
				|		) КАК ЗапросТовары
		        |		ПО (ЗапросТовары.Номенклатура = ДокСтроки1.Номенклатура) 				
				|) КАК РеализацияТоваровУслугТовары
			|ПО (РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка) ";
	Иначе
		ТекстОтбор = "
	|        ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.РеализацияТоваровУслуг.Товары КАК РеализацияТоваровУслугТовары
	|        	ПО (РеализацияТоваровУслугТовары.Ссылка = РеализацияТоваровУслуг.Ссылка) ";	
	КонецЕсли;
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Отбор_по_НоменклатураСоответствия@", ТекстОтбор );
	
    Если ПараметрыФункции["РеквизитГрузополучатель"] = 0 Тогда
        // Контрагент
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель@", "РеализацияТоваровУслуг.Контрагент ");        
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Связи@", " (РеализацияТоваровУслуг.Контрагент = ЗапросПлощадки.Контрагент)  ");
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Группировка@", "РеализацияТоваровУслуг.Контрагент,  ");        
    Иначе // Грузополучатель
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель@", "ПОДСТРОКА(РеализацияТоваровУслуг.АдресДоставки, 1, 100) ");
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Связи@", " (ПОДСТРОКА(РеализацияТоваровУслуг.АдресДоставки, 1, 100) = ЗапросПлощадки.Контрагент) ") ;
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Группировка@", " ПОДСТРОКА(РеализацияТоваровУслуг.АдресДоставки, 1, 100), ");
    КонецЕсли;

    Если ПараметрыФункции["ПарамФильтроватьРеализациюПоСкладуПлощадкиОтправителя"] Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Отбор_по_Складам@", " И РеализацияТоваровУслуг.Склад В ИЕРАРХИИ(&ПлощадкаОтправителяСклад) ");        
    Иначе
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Отбор_по_Складам@", "  ");        
    КонецЕсли;

    Если ЗначениеЗаполнено( ПараметрыФункции["Маршрут"] ) Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Маршрут@", "РеализацияТоваровУслуг.Маршрут КАК Маршрут,");        
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Маршрут_Условие@", " И РеализацияТоваровУслуг.Маршрут В ИЕРАРХИИ(&ВыбМаршрут) ");        
    Иначе
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Маршрут@", " ");        
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Маршрут_Условие@", " ");        		
	КонецЕсли;    

	//// Пересчет ШТ в КГ
	//Версия = Лев(Метаданные.Версия,2);		
	//Если Метаданные.Имя = "УправлениеТорговлей" И Версия="11" Тогда 				
	//	КПересчета = "ДокСтроки1.Номенклатура.ВесЧислитель / ДокСтроки1.Номенклатура.ВесЗнаменатель";
	//	Запрос.Текст = СтрЗаменить( Запрос.Текст, "@КоэффициентПересчета@", КПересчета );				
	//Иначе // остальные считаем с учетом параметра [ПарамКоэффициентПересчетаКоличества]		
	    КПересчета = ПараметрыФункции["ПарамКоэффициентПересчетаКоличества"];
	    Коэфф = 0;
	    Попытка
	        Коэфф = Число(КПересчета);
	    Исключение
	        Коэфф = 0;
	    КонецПопытки;
	    Если НЕ(ЗначениеЗаполнено(КПересчета)) Тогда
	        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоэффициентПересчета@","1");
	    ИначеЕсли Строка(Коэфф)    = КПересчета Тогда  // Это число
	        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоэффициентПересчета@",КПересчета);
		Иначе 			
			// Не работает, если коэфф не целочисленный
			Запрос.Текст = СтрЗаменить( Запрос.Текст, "@КоэффициентПересчета@", "ДокСтроки1."+КПересчета );	
			
	    // Ошибка        ТЗамены = "РеализацияТоваровУслугТовары."+КПересчета;
	    //        ТекстПодстановки = " 
	    //        |Выбор Когда Значение("+ТЗамены+")= 0 Тогда
	    //        |СУММА(РеализацияТоваровУслугТовары.@Количество) 
	    //        |Иначе
	    //        |СУММА("+Тзамены+"*РеализацияТоваровУслугТовары.@Количество)
	    //        |Конец
	    //        |КАК Количество,";
	    //        ТекстПодстановки = СтрЗаменить(ТекстПодстановки,"@Количество",СписокКонстант.Получить("НазваниеРеквизитаКоличество"));
	    //        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоэффициентПересчета",ТекстПодстановки);
		КонецЕсли;
	//КонецЕсли; 
	
    Если ЗначениеЗаполнено( ПараметрыФункции["НазваниеРеквизитаКоличество"] ) Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@Количество@", ПараметрыФункции["НазваниеРеквизитаКоличество"]);
    Иначе
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@Количество@", "Количество");
	КонецЕсли;
    Если ЗначениеЗаполнено( ПараметрыФункции["НазваниеРеквизитаКоличествоМест"] ) Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоличествоМест@", ПараметрыФункции["НазваниеРеквизитаКоличествоМест"]);
    Иначе
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоличествоМест@", "Количество");
	КонецЕсли;


    Попытка
        Рез = Запрос.Выполнить();
    Исключение
        Рез = Неопределено;
        кб99_ВСД.СообщитьИнфо("Указан неверный параметр НазваниеРеквизитаКоличество или ПарамКоэффициентПересчетаКоличества "+Описаниеошибки());
    КонецПопытки;

    Возврат Рез;
	
КонецФункции // СформироватьЗапрос()

&НаСервере
Функция СформироватьЗапросПеремещения( ПараметрыФункции ) Экспорт
	ПереопределенныйМодуль = ФункцияПереопределена("СформироватьЗапросПеремещения");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.СформироватьЗапросПеремещения( ПараметрыФункции );
	КонецЕсли;	
	
	// ЖД - В документе ПеремещениеТоваров участвуют склады ХС
	// в таком случае как в 7.7 нужно добавить реквизит Склад к спр. ВСД_Площадка
	// По Складу Получателю определяем площадку
	// ХС один и тот же -или по фирме документа определять, или берем тек параметры, т.к фирма уже определена там
	// также ищем уже созданные транзакции
	
	Запрос = Новый Запрос;
	// Запрос.УстановитьПараметр("Регистраторы",				Регистраторы);
	Запрос.УстановитьПараметр("ДатаНачала",					НачалоДня( ПараметрыФункции["ДатаНачала"] ) );
	Запрос.УстановитьПараметр("ДатаОкончания",				КонецДня( ПараметрыФункции["ДатаОкончания"] ));
	Запрос.УстановитьПараметр("СписокОрганизаций",			ПараметрыФункции["Организации"] );
	// Запрос.УстановитьПараметр("ПлощадкаОтправителяСклад",				ПлощадкаОтправителя.Склад);  
    Если ПараметрыФункции["ПарамФильтроватьРеализациюПоСкладуПлощадкиОтправителя"] Тогда
        Попытка 
            Запрос.УстановитьПараметр("ПлощадкаОтправителяСклад",    ПараметрыФункции["ПлощадкаОтправителя"].Склад );
            Если НЕ(ЗначениеЗаполнено( ПараметрыФункции["ПлощадкаОтправителя"].Склад ) ) Тогда
                кб99_ВСД.СообщитьИнфо("Не определен Склад по Площадке "+ПараметрыФункции["ПлощадкаОтправителя"]+" привяжите склад к площадке либо отключите параметр [Фильтровать Реализацию По Складу Площадки Отправителя]!");    
            КонецЕсли;
        Исключение 
            Запрос.УстановитьПараметр("ПлощадкаОтправителяСклад", ""); 
            кб99_ВСД.СообщитьИнфо("Не определен Склад по Площадке для фильтрации документов!"); 
        КонецПопытки;    
    КонецЕсли;

	// Запрос.УстановитьПараметр("ПодразделениеОрганизации",	ПодразделениеОрганизации);
	
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ПеремещениеТоваров.Ссылка КАК Док,
	|	ПеремещениеТоваров.СкладПолучатель КАК Грузополучатель,
	|	СУММА(ПеремещениеТоваровТовары.@Количество@) КАК Количество,
	|	СУММА(ПеремещениеТоваровТовары.@КоличествоМест@) КАК КоличествоМест,
	|	ВСД_Площадка.Ссылка КАК Площадка,
	|	ВСД_транзакция.Ссылка КАК ВСД,
	|	ПеремещениеТоваров.Номер КАК Номер,
	|	ПеремещениеТоваров.Дата КАК Дата
	|ИЗ
	|	Документ.ПеремещениеТоваров КАК ПеремещениеТоваров
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ВСД_транзакция КАК ВСД_транзакция
	|		ПО (ВСД_транзакция.ДокументОснование = ПеремещениеТоваров.Ссылка)
	|			И (ВСД_транзакция.ПометкаУдаления = ЛОЖЬ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВСД_Площадка КАК ВСД_Площадка
	|		ПО (ПеремещениеТоваров.СкладПолучатель = ВСД_Площадка.Склад)
	|			И (ВСД_Площадка.ПометкаУдаления = ЛОЖЬ)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Документ.ПеремещениеТоваров.Товары КАК ПеремещениеТоваровТовары
	|		ПО (ПеремещениеТоваровТовары.Ссылка = ПеремещениеТоваров.Ссылка)
	|ГДЕ
	|	ПеремещениеТоваров.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И ПеремещениеТоваров.Организация В ИЕРАРХИИ(&СписокОрганизаций)
	|	И ПеремещениеТоваров.СкладОтправитель = &ПлощадкаОтправителяСклад
	|
	|СГРУППИРОВАТЬ ПО
	|	ПеремещениеТоваров.Ссылка,
	|	ВСД_Площадка.Ссылка,
	|	ВСД_транзакция.Ссылка,
	|	ПеремещениеТоваров.Номер,
	|	ПеремещениеТоваров.Дата
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата,
	|	Номер";
	
	// v 2.*
	Запрос.Текст = СтрЗаменить(Запрос.Текст,"ВСД_транзакция","ВСД2_транзакция");
    Если ЗначениеЗаполнено( ПараметрыФункции["НазваниеРеквизитаКоличество"] ) Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@Количество@", ПараметрыФункции["НазваниеРеквизитаКоличество"]);
    Иначе
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@Количество@", "Количество");
	КонецЕсли;
	
	Если ЗначениеЗаполнено( ПараметрыФункции["НазваниеРеквизитаКоличествоМест"] ) Тогда
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоличествоМест@", ПараметрыФункции["НазваниеРеквизитаКоличествоМест"]);
    Иначе
        Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоличествоМест@", "Количество");
	КонецЕсли;
	
	Запрос.Выполнить();
		
	Возврат Запрос.Выполнить();
КонецФункции // СформироватьЗапрос()

&НаСервере
Функция СформироватьЗапросЗаказы( ПараметрыФункции ) Экспорт
	
	ПереопределенныйМодуль = ФункцияПереопределена("СформироватьЗапросПеремещения");
	Если ПереопределенныйМодуль <> Неопределено Тогда
		Возврат ПереопределенныйМодуль.СформироватьЗапросПеремещения( ПараметрыФункции );
	КонецЕсли;	
	
	Запрос = Новый Запрос;
	Запрос.УстановитьПараметр("ДатаНачала",					НачалоДня( ПараметрыФункции["ДатаНачала"] ) );
	Запрос.УстановитьПараметр("ДатаОкончания",				КонецДня( ПараметрыФункции["ДатаОкончания"] ));
	Запрос.УстановитьПараметр("СписокОрганизаций",			ПараметрыФункции["Организации"] );
		
	Запрос.МенеджерВременныхТаблиц = Новый МенеджерВременныхТаблиц;
	
	Запрос.Текст =
	"ВЫБРАТЬ
	|	ЗаказПокупателя.Ссылка КАК Док,
	|    @Грузополучатель@ КАК Грузополучатель,
	|	ЗаказПокупателя.Номер КАК Номер,
	|	ЗаказПокупателя.Дата КАК Дата,
	|	СУММА(ЗаказПокупателяТовары.@Количество@) КАК Количество,
	|	ВСД_ХозСубъект.Ссылка КАК ХозСубъект,
	|	ЗапросПлощадки.ВСД_Площадка КАК Площадка,
	|	СУММА(ЗаказПокупателяТовары.Сумма) КАК Сумма,
	|	ЗаказПокупателя.Контрагент.ГоловнойКонтрагент КАК Контрагент,
	|	СУММА(ЗаказПокупателяТовары.@КоличествоМест@) КАК КоличествоМест
	|ИЗ
	|	Документ.ЗаказПокупателя КАК ЗаказПокупателя
	|		ЛЕВОЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
	|			ВСД_ХозСубъект.Ссылка КАК ХС,
	|			ВСД_ХозСубъект.Контрагент КАК КонтрагентХС,
	|			ВСД_Площадка.Ссылка КАК ВСД_Площадка,
	|			ВСД_Площадка.Контрагент КАК Контрагент
	|		ИЗ
	|			Справочник.ВСД_ХозСубъект КАК ВСД_ХозСубъект
	|				ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВСД_Площадка КАК ВСД_Площадка
	|				ПО (ВСД_Площадка.ХозСубъект = ВСД_ХозСубъект.Ссылка)
	|					И (ВСД_Площадка.ПометкаУдаления = ЛОЖЬ)
	|		ГДЕ
	|			ВСД_ХозСубъект.ПометкаУдаления = ЛОЖЬ
	|			И НЕ ВСД_ХозСубъект.Контрагент ЕСТЬ NULL) КАК ЗапросПлощадки
	|		ПО @Грузополучатель_Связи@
	|			И ЗаказПокупателя.Контрагент.ГоловнойКонтрагент = ЗапросПлощадки.КонтрагентХС
	|			И (НЕ ЗаказПокупателя.Контрагент.ГоловнойКонтрагент ЕСТЬ NULL)
	|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.ВСД_ХозСубъект КАК ВСД_ХозСубъект
	|		ПО ЗаказПокупателя.Контрагент.ГоловнойКонтрагент = ВСД_ХозСубъект.Контрагент
	|			И (ВСД_ХозСубъект.ПометкаУдаления = ЛОЖЬ)
	|		@Отбор_по_НоменклатураСоответствия@
	|ГДЕ
	|	ЗаказПокупателя.Дата МЕЖДУ &ДатаНачала И &ДатаОкончания
	|	И ЗаказПокупателя.Организация В ИЕРАРХИИ(&СписокОрганизаций)
	|	И ЗаказПокупателя.Проведен = ИСТИНА
	|	И ЗаказПокупателя.Товары.Сумма > 0
	|
	|СГРУППИРОВАТЬ ПО
	|	ЗаказПокупателя.Ссылка,
	|	@Грузополучатель_Группировка@
	|	ЗапросПлощадки.ВСД_Площадка,
	|	ВСД_ХозСубъект.Ссылка,
	|	ЗаказПокупателя.Номер,
	|	ЗаказПокупателя.Дата
	|
	|УПОРЯДОЧИТЬ ПО
	|	Дата,
	|	Номер";
			
	Если ПараметрыФункции["ПропускатьПустыеСвойства"] Тогда
		ТекстОтбор = "
			|ВНУТРЕННЕЕ СОЕДИНЕНИЕ 
			|	(ВЫБРАТЬ
				|	ДокСтроки1.Ссылка КАК Ссылка,
		        |	ДокСтроки1.Номенклатура КАК Номенклатура,
		        |	ЗапросТовары.ПродукцияЭлемент КАК ПродукцияЭлемент,				
		        |	(ДокСтроки1.@Количество@ * @КоэффициентПересчета@ ) КАК @Количество@,
				|	ДокСтроки1.Сумма КАК Сумма
		        |ИЗ
		        |	Документ.ЗаказПокупателя.Товары КАК ДокСтроки1
		        |		ВНУТРЕННЕЕ СОЕДИНЕНИЕ (ВЫБРАТЬ
		        |			Спр1.ПродукцияЭлемент КАК ПродукцияЭлемент,
		        |			Спр1.Владелец КАК Номенклатура
		        |		ИЗ
		        |			Справочник.ВСД_Соответсвия КАК Спр1
		        |		ГДЕ
		        |			НЕ Спр1.ПродукцияЭлемент ЕСТЬ NULL
				|			И Спр1.ПометкаУдаления = ЛОЖЬ
				|		) КАК ЗапросТовары
		        |		ПО (ЗапросТовары.Номенклатура = ДокСтроки1.Номенклатура) 				
				|) КАК ЗаказПокупателяТовары
			|ПО (ЗаказПокупателяТовары.Ссылка = ЗаказПокупателя.Ссылка) ";
	Иначе
		ТекстОтбор = "
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Документ.ЗаказПокупателя.Товары КАК ЗаказПокупателяТовары
		|		ПО (ЗаказПокупателя.Ссылка = ЗаказПокупателяТовары.Ссылка)";
		
	КонецЕсли;
	Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Отбор_по_НоменклатураСоответствия@", ТекстОтбор );
	
	Если ПараметрыФункции["РеквизитГрузополучатель"] = 0 Тогда
        // Контрагент
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель@", " ЗаказПокупателя.Контрагент ");        
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Связи@", " (ЗаказПокупателя.Контрагент = ЗапросПлощадки.Контрагент)  ");
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Группировка@", " ЗаказПокупателя.Контрагент,  ");        
    Иначе // Грузополучатель
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель@", "ПОДСТРОКА(ЗаказПокупателя.АдресДоставки, 1, 100) ");
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Связи@", " (ПОДСТРОКА(ЗаказПокупателя.АдресДоставки, 1, 100) = ЗапросПлощадки.Контрагент) ") ;
        Запрос.Текст = СтрЗаменить(Запрос.Текст, "@Грузополучатель_Группировка@", " ПОДСТРОКА(ЗаказПокупателя.АдресДоставки, 1, 100), ");
	КонецЕсли;
	
	КПересчета = ПараметрыФункции["ПарамКоэффициентПересчетаКоличества"];
	Коэфф = 0;
	Попытка
		Коэфф = Число(КПересчета);
	Исключение
		Коэфф = 0;
	КонецПопытки;
	Если НЕ(ЗначениеЗаполнено(КПересчета)) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоэффициентПересчета@","1");
	ИначеЕсли Строка(Коэфф)    = КПересчета Тогда  // Это число
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоэффициентПересчета@",КПересчета);
	Иначе 			
		// Не работает, если коэфф не целочисленный
		Запрос.Текст = СтрЗаменить( Запрос.Текст, "@КоэффициентПересчета@", "ДокСтроки1."+КПересчета );	
	КонецЕсли;
	
	
	Если ЗначениеЗаполнено( ПараметрыФункции["НазваниеРеквизитаКоличество"] ) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"@Количество@", ПараметрыФункции["НазваниеРеквизитаКоличество"]);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"@Количество@", "Количество");
	КонецЕсли;
	Если ЗначениеЗаполнено( ПараметрыФункции["НазваниеРеквизитаКоличествоМест"] ) Тогда
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоличествоМест@", ПараметрыФункции["НазваниеРеквизитаКоличествоМест"]);
	Иначе
		Запрос.Текст = СтрЗаменить(Запрос.Текст,"@КоличествоМест@", "Количество");
	КонецЕсли;

    Попытка
        Рез = Запрос.Выполнить();
    Исключение
        Рез = Неопределено;
        кб99_ВСД.СообщитьИнфо("Указан неверный параметр НазваниеРеквизитаКоличество или ПарамКоэффициентПересчетаКоличества "+Описаниеошибки());
    КонецПопытки;
	
	Возврат Рез;
	
КонецФункции

#КонецОбласти 

Функция НайтиApplicationID( Ссылка ) Экспорт 
	
	Отбор = Новый Структура;
	Отбор.Вставить("Объект", Ссылка);
	Обращение = РегистрыСведений.кб99_Запросы.ПолучитьПоследнее(ТекущаяДата(), Отбор );
	
	Возврат Обращение.ApplicationID;
КонецФункции

Функция НайтиПоследнийЗапрос( Объект ) Экспорт 
	
	Отбор = Новый Структура;
	Отбор.Вставить("Объект", Объект);
	Обращение = РегистрыСведений.кб99_Запросы.ПолучитьПоследнее(ТекущаяДата(), Отбор );
	
	Возврат Обращение;
КонецФункции
